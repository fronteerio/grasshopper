/**
 * Copyright (c) 2015 "Fronteer LTD"
 * Grasshopper Event Engine
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

var _ = require('lodash');

var GrassHopper = require('gh-core');
var GrasshopperUtil = require('gh-core/lib/util');

var EventsAPI = require('./api');

/**
 * @REST getEvent
 *
 * Get an event
 *
 * @Server      admin,app
 * @Method      GET
 * @Path        /events/{id}
 * @PathParam   {number}            id                  The id of the event to retrieve
 * @Return      {Event}                                 The requested event
 */
var _getEvent = function(req, res) {
    EventsAPI.getEvent(req.ctx, req.params.id, function(err, event) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send(event);
    });
};

GrassHopper.globalAdminRouter.on('get', '/api/events/:id', _getEvent);
GrassHopper.appRouter.on('get', '/api/events/:id', _getEvent);

/**
 * @REST createEvent
 *
 * Create a new event in the current app
 *
 * @Server      app
 * @Method      POST
 * @Path        /events
 * @FormParam   {string}            displayName         The name of the event
 * @FormParam   {string}            end                 The timestamp (ISO 8601) at which the event ends
 * @FormParam   {string}            start               The timestamp (ISO 8601) at which the event starts
 * @FormParam   {string}            [description]       The description of the event
 * @FormParam   {number}            [group]             The id of the group that can manage the event
 * @FormParam   {string}            [location]          The location of the event
 * @FormParam   {string}            [notes]             The notes for the event
 * @FormParam   {string[]}          [organiserOther]    The name(s) of the unrecognised user(s) that organise the event. If no organisers are added, the current user will be added as the organiser
 * @FormParam   {string[]}          [organiserUser]     The id(s) of the recognised user(s) that organise the event
 * @FormParam   {number}            [serie]             The id(s) of the serie(s) that the event belongs to
 * @Return      {Event}                                 The created event
 */

/**
 * @REST createEventByApp
 *
 * Create a new event in an app
 *
 * @Server      admin
 * @Method      POST
 * @Path        /events
 * @FormParam   {number}            app                 The id of the app to create the event for
 * @FormParam   {string}            displayName         The name of the event
 * @FormParam   {string}            end                 The timestamp (ISO 8601) at which the event ends
 * @FormParam   {string}            start               The timestamp (ISO 8601) at which the event starts
 * @FormParam   {string}            [description]       The description of the event
 * @FormParam   {number}            [group]             The id of the group that can manage the event
 * @FormParam   {string}            [location]          The location of the event
 * @FormParam   {string}            [notes]             The notes for the event
 * @FormParam   {string[]}          [organiserOther]    The name(s) of the unrecognised user(s) that organise the event. If no organisers are added, the current user will be added as the organiser
 * @FormParam   {number[]}          [organiserUsers]    The id(s) of the recognised user(s) that organise the event
 * @FormParam   {number[]}          [series]            The id(s) of the serie(s) that the event belongs to
 * @FormParam   {string}            [type]              The type of the event
 * @Return      {Event}                                 The created event
 */
var _createEvent = function(req, res) {
    var opts = {
        'description': req.body.description,
        'group': req.body.group,
        'location': req.body.location,
        'notes': req.body.notes,
        'organiserOther': GrasshopperUtil.toArray(req.body.organiserOther),
        'organiserUsers': GrasshopperUtil.toArray(req.body.organiserUsers),
        'series': GrasshopperUtil.toArray(req.body.series),
        'type': req.body.type
    };

    EventsAPI.createEvent(req.ctx, req.body.app, req.body.displayName, req.body.start, req.body.end, opts, function(err, event) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(201).send(event);
    });
};
GrassHopper.appRouter.on('post', '/api/events', _createEvent);
GrassHopper.globalAdminRouter.on('post', '/api/events', _createEvent);

/**
 * @REST updateEvent
 *
 * Update an event
 *
 * @Server      admin,app
 * @Method      POST
 * @Path        /events/{id}
 * @PathParam   {number}                id                  The id of the event to update
 * @FormParam   {string}                [description]       The updated event description
 * @FormParam   {string}                [displayName]       The updated event name
 * @FormParam   {string}                [end]               The updated timestamp (ISO 8601) at which the event ends
 * @FormParam   {string}                [location]          The updated event location
 * @FormParam   {group}                 [group]             The updated id of the group that can manage the event
 * @FormParam   {string}                [notes]             The updated notes for the event
 * @FormParam   {string}                [start]             The updated timestamp (ISO 8601) at which the event starts
 * @FormParam   {string}                [type]              The updated event type
 * @Return      {Event}                                     The updated event
 */
var _updateEvent = function(req, res) {
    EventsAPI.updateEvent(req.ctx, req.params.id, req.body, function(err, event) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send(event);
    });
};

GrassHopper.globalAdminRouter.on('post', '/api/events/:id', _updateEvent);
GrassHopper.appRouter.on('post', '/api/events/:id', _updateEvent);

/**
 * @REST updateEventOrganisers
 *
 * Update the organisers of an event
 *
 * @Server      admin,app
 * @Method      POST
 * @Path        /events/{id}/organisers
 * @PathParam   {number}                id                  The id of the event for which to update the organisers
 * @BodyParam   {EventOrganiserUpdate}  body                Object that describes the event organiser changes to apply. Keys that are numbers are considered to be references to users, anything else is considered to be a plain-text organiser
 * @Return      {Event}                                     The updated event
 */
var _updateEventOrganisers = function(req, res) {
    var updateById = {};
    var updateByText = {};
    _.each(req.body, function(val, key) {
        if (_.isNaN(parseInt(key, 10))) {
            updateByText[key] = val;
        } else {
            updateById[key] = val;
        }
    });

    EventsAPI.updateEventOrganisers(req.ctx, req.params.id, updateById, updateByText, function(err, event) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send(event);
    });
};

GrassHopper.globalAdminRouter.on('post', '/api/events/:id/organisers', _updateEventOrganisers);
GrassHopper.appRouter.on('post', '/api/events/:id/organisers', _updateEventOrganisers);

/**
 * @REST setEventPicture
 *
 * Store a picture for an event
 *
 * @Server      admin,app
 * @Method      POST
 * @Path        /events/{id}/picture
 * @PathParam   {number}                id                  The id of the event to store the picture for
 * @FormParam   {File}                  file                Image that should be stored as the event picture
 * @Return      {Event}                                     The updated event
 */
var _setEventPicture = function(req, res) {
    res.sendStatus(501);
};

GrassHopper.globalAdminRouter.on('post', '/api/events/:id/picture', _setEventPicture);
GrassHopper.appRouter.on('post', '/api/events/:id/picture', _setEventPicture);

/**
 * @REST cropEventPicture
 *
 * Crop the picture for an event
 *
 * @Server      admin,app
 * @Method      POST
 * @Path        /events/{id}/picture/crop
 * @FormParam   {number}        id                      The id of the event to crop the picture for
 * @FormParam   {number}        width                   The width of the square that needs to be cropped out
 * @FormParam   {number}        x                       The x coordinate of the top left corner to start cropping at
 * @FormParam   {number}        y                       The y coordinate of the top left corner to start cropping at
 * @Return      {Event}                                The updated event
 */
var _cropEventPicture = function(req, res) {
    res.sendStatus(501);
};

GrassHopper.globalAdminRouter.on('post', '/api/events/:id/picture/crop', _cropEventPicture);
GrassHopper.appRouter.on('post', '/api/events/:id/picture/crop', _cropEventPicture);

/**
 * @REST deleteEvent
 *
 * Delete an event
 *
 * @Server      admin,app
 * @Method      DELETE
 * @Path        /events/{id}
 * @PathParam   {number}            id                  The id of the event to delete
 * @Return      {void}
 */
var _deleteEvent = function(req, res) {
    EventsAPI.deleteEvent(req.ctx, req.params.id, function(err) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.status(200).send();
    });
};

GrassHopper.globalAdminRouter.on('delete', '/api/events/:id', _deleteEvent);
GrassHopper.appRouter.on('delete', '/api/events/:id', _deleteEvent);

/**
 * @REST getEventSubscribers
 *
 * Get the users that have subscribed to an event series
 *
 * @Server      admin,app
 * @Method      POST
 * @Path        /series/{id}/subscribers
 * @PathParam   {number}            id                  The id of the event to get the subscribers for
 * @QueryParam  {number}            [limit]             The maximum number of results to retrieve. Default: 10
 * @QueryParam  {number}            [offset]            The paging number of the results to retrieve
 * @Return      {UserList}                              The users that have subscribed to the event
 */
var _getEventSubscribers = function(req, res) {
    res.sendStatus(501);
};

GrassHopper.globalAdminRouter.on('post', '/api/events/:id/subscribers', _getEventSubscribers);
GrassHopper.appRouter.on('post', '/api/events/:id/subscribers', _getEventSubscribers);

/**
 * @REST subscribeEvent
 *
 * Subscribe to an event
 *
 * @Server      admin,app
 * @Method      POST
 * @Path        /events/{id}/subscribe
 * @PathParam   {number}            id                  The id of the event to subscribe to
 * @Return      {void}
 */
var _subscribeEvent = function(req, res) {
    res.sendStatus(501);
};

GrassHopper.globalAdminRouter.on('post', '/api/events/:id/subscribe', _subscribeEvent);
GrassHopper.appRouter.on('post', '/api/events/:id/subscribe', _subscribeEvent);
